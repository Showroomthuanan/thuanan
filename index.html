<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">Thêm Đơn Hàng</h2>
        <form id="orderForm" class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Chọn Tư Vấn BH</label>
                <select class="form-select" id="advisor" required>
                    <option selected disabled>Chọn Tư Vấn BH</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Chọn Dòng Xe</label>
                <select class="form-select" id="carModel" required>
                    <option selected disabled>Chọn Dòng Xe</option>
                    <option value="VF8">VF8</option>
                    <option value="VF9">VF9</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Phiên Bản</label>
                <input type="text" class="form-control" id="version">
            </div>
            <div class="col-md-6">
                <label class="form-label">Ngoại Thất</label>
                <input type="text" class="form-control" id="exterior">
            </div>
            <div class="col-md-6">
                <label class="form-label">Nội Thất</label>
                <input type="text" class="form-control" id="interior">
            </div>
            <div class="col-md-6">
                <label class="form-label">VSO</label>
                <input type="text" class="form-control" id="vso">
            </div>
            <div class="col-md-6">
                <label class="form-label">Tên KH</label>
                <input type="text" class="form-control" id="customerName" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Ngày Cọc</label>
                <input type="date" class="form-control" id="depositDate">
            </div>
            <div class="col-md-6">
                <label class="form-label">Tình Trạng Thanh Toán</label>
                <input type="text" class="form-control" id="paymentStatus">
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-primary w-100" onclick="addOrder()">Thêm Đơn Hàng</button>
            </div>
        </form>
        <p id="statusMessage" class="mt-3 text-danger"></p>
    </div>
    <div class="container mt-4">
        <h4>Danh Sách Đơn Hàng (<span id="orderCount">0</span>)</h4>
        <table class="table table-bordered mt-3" id="orderTable">
            <thead>
                <tr>
                    <th>Tư Vấn BH</th>
                    <th>Dòng Xe</th>
                    <th>Phiên Bản</th>
                    <th>Ngoại Thất</th>
                    <th>Nội Thất</th>
                    <th>VSO</th>
                    <th>Tên KH</th>
                    <th>Ngày Cọc</th>
                    <th>Thanh Toán</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-success" onclick="exportToExcel()">Xuất Excel</button>
    </div>

    <script>
    function addOrder() {
        let formData = {
            advisor: document.getElementById("advisor").value,
            carModel: document.getElementById("carModel").value,
            version: document.getElementById("version").value,
            exterior: document.getElementById("exterior").value,
            interior: document.getElementById("interior").value,
            vso: document.getElementById("vso").value,
            customerName: document.getElementById("customerName").value,
            depositDate: document.getElementById("depositDate").value,
            paymentStatus: document.getElementById("paymentStatus").value
        };

        // Kiểm tra dữ liệu trước khi gửi
        if (!formData.advisor || !formData.carModel || !formData.customerName) {
            document.getElementById("statusMessage").textContent = "Vui lòng điền đầy đủ thông tin bắt buộc!";
            return;
        }

        fetch("https://script.google.com/macros/s/AKfycbwDut4uFVL1Dlo2x-SqsUj5UJ4plXhVJIhXWYsP3RIYfnZsjNNpXAkp9rlSFV8HYoK_/exec", { 
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.result === "success") {
                document.getElementById("statusMessage").textContent = "Thêm đơn hàng thành công!";
                document.getElementById("statusMessage").classList.remove("text-danger");
                document.getElementById("statusMessage").classList.add("text-success");

                updateOrderList(formData); // Cập nhật bảng danh sách đơn hàng
            } else {
                document.getElementById("statusMessage").textContent = "Lỗi khi gửi dữ liệu!";
            }
        })
        .catch(error => {
            document.getElementById("statusMessage").textContent = "Lỗi kết nối, vui lòng thử lại!";
            console.error("Error:", error);
        });
    }

    function updateOrderList(formData) {
        let table = document.querySelector("#orderTable tbody");
        let row = table.insertRow();
        Object.values(formData).forEach((data, index) => row.insertCell(index).textContent = data);
        document.getElementById("orderCount").textContent = table.rows.length;
    }

    function exportToExcel() {
        let table = document.getElementById("orderTable");
        if (table.rows.length <= 1) {
            alert("Không có dữ liệu để xuất!");
            return;
        }
        
        let ws = XLSX.utils.table_to_sheet(table);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Đơn Hàng");
        XLSX.writeFile(wb, "DanhSachDonHang.xlsx");
    }
</script>
</body>
</html>
